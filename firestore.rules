rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper admin
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email == 'antho.pruneta@gmail.com';
    }

    // Règles pour la collection 'characters'
    match /characters/{userId} {
      // Lecture : Tous les utilisateurs connectés peuvent voir les personnages
      // (nécessaire pour le combat et voir les adversaires)
      allow read: if request.auth != null;

      // Écriture : L'utilisateur peut créer/modifier son propre personnage
      allow write: if request.auth != null && request.auth.uid == userId;

      // Mise à jour image : Seulement les admins
      allow update: if isAdmin();

      // Suppression : Seulement les admins
      allow delete: if isAdmin();
    }

    // Règles pour la collection 'dungeonProgress'
    match /dungeonProgress/{userId} {
      // Lecture : joueur lui-même ou admin
      allow read: if request.auth != null &&
                     (request.auth.uid == userId || isAdmin());

      // Écriture : joueur lui-même OU admin
      // (important pour l'ajout global d'essais)
      allow write: if request.auth != null &&
                      (request.auth.uid == userId || isAdmin());
    }

    // Broadcasts admin (pop-up d'annonce globale)
    match /adminBroadcasts/{broadcastId} {
      // Lecture : tous les utilisateurs connectés (pour afficher la pop-up)
      allow read: if request.auth != null;
      // Écriture : admin uniquement
      allow write: if isAdmin();
    }

    // Configuration globale du jeu (équilibrage persistant)
    // Ex: gameConfig/balance
    match /gameConfig/{configId} {
      // Lecture : utilisateurs connectés (chargement au boot de l'app)
      allow read: if request.auth != null;
      // Écriture : admin uniquement
      allow write: if isAdmin();
    }

    // Milestones globaux (premiers kills/clears)
    match /globalMilestones/{milestoneId} {
      // Lecture : utilisateurs connectés
      allow read: if request.auth != null;
      // Écriture : utilisateurs connectés (création contrôlée côté transaction)
      allow write: if request.auth != null;
    }

    // Règles pour les rolls en attente (lock du roll)
    match /pendingRolls/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Règles pour le tournoi
    match /tournaments/{tournamentId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();

      // Sous-collection combatLogs
      match /combatLogs/{matchId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
      }
    }

    // Règles pour le Hall of Fame
    match /hallOfFame/{entryId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Règles pour les personnages archivés
    match /archivedCharacters/{charId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Règles pour les récompenses de tournoi
    match /tournamentRewards/{userId} {
      allow read: if request.auth != null &&
                     (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin();
    }

    // Labyrinthe infini hebdomadaire (admin only en écriture)
    match /weeklyInfiniteLabyrinths/{weekId} {
      // Lecture: utilisateurs connectés (utile pour affichage admin/test)
      allow read: if request.auth != null;
      // Écriture: admin uniquement
      allow write: if isAdmin();
    }

    // Boss mondial (Cataclysme)
    match /worldBossEvent/{eventId} {
      // Lecture : utilisateurs connectés (état de l'event, HP restant)
      allow read: if request.auth != null;
      // Écriture : utilisateurs connectés (batch damage + update HP)
      allow write: if request.auth != null;

      // Sous-collection dégâts par personnage
      match /damages/{characterId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    // Progression Labyrinthe par joueur et par semaine
    // Structure: userLabyrinthProgress/{userId}/weeks/{weekId}
    match /userLabyrinthProgress/{userId} {
      allow read, write: if request.auth != null &&
                           (request.auth.uid == userId || isAdmin());

      match /weeks/{weekId} {
        allow read, write: if request.auth != null &&
                             (request.auth.uid == userId || isAdmin());
      }
    }
  }
}
