rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Règles pour la collection 'characters'
    match /characters/{userId} {
      // Lecture : L'utilisateur peut lire son propre personnage ou tout admin
      allow read: if request.auth != null &&
                     (request.auth.uid == userId ||
                      request.auth.token.email == 'antho.pruneta@gmail.com');

      // Écriture : L'utilisateur peut créer/modifier son propre personnage
      allow write: if request.auth != null && request.auth.uid == userId;

      // Suppression : Seulement les admins
      allow delete: if request.auth != null &&
                       request.auth.token.email == 'antho.pruneta@gmail.com';
    }

    // Règle pour permettre aux admins de lister tous les personnages
    match /characters/{document=**} {
      allow read: if request.auth != null &&
                     request.auth.token.email == 'antho.pruneta@gmail.com';
    }

    // Règles pour la collection 'dungeonProgress'
    match /dungeonProgress/{userId} {
      // Lecture : L'utilisateur peut lire sa propre progression ou tout admin
      allow read: if request.auth != null &&
                     (request.auth.uid == userId ||
                      request.auth.token.email == 'antho.pruneta@gmail.com');

      // Écriture : L'utilisateur peut créer/modifier sa propre progression
      // OU admin (nécessaire pour l'attribution globale d'essais)
      allow write: if request.auth != null &&
                      (request.auth.uid == userId ||
                       request.auth.token.email == 'antho.pruneta@gmail.com');
    }

    // Broadcasts admin (pop-up d'annonce globale)
    match /adminBroadcasts/{broadcastId} {
      // Lecture : tous les utilisateurs connectés (pour afficher la pop-up)
      allow read: if request.auth != null;
      // Écriture : admin uniquement
      allow write: if request.auth != null &&
                      request.auth.token.email == 'antho.pruneta@gmail.com';
    }

    // Règles pour le tournoi
    match /tournaments/{tournamentId} {
      // Lecture : Tous les utilisateurs connectés
      allow read: if request.auth != null;

      // Écriture : Admin uniquement
      allow write: if request.auth != null &&
                      request.auth.token.email == 'antho.pruneta@gmail.com';

      // Sous-collection combatLogs
      match /combatLogs/{matchId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null &&
                        request.auth.token.email == 'antho.pruneta@gmail.com';
      }
    }

    // Règles pour le Hall of Fame
    match /hallOfFame/{entryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      request.auth.token.email == 'antho.pruneta@gmail.com';
    }

    // Règles pour les personnages archivés
    match /archivedCharacters/{charId} {
      // Lecture : L'utilisateur peut lire ses propres archives + admin
      allow read: if request.auth != null;
      // Écriture : Admin uniquement (via terminerTournoi)
      allow write: if request.auth != null &&
                      request.auth.token.email == 'antho.pruneta@gmail.com';
    }

    // Règles pour les rolls en attente (lock du roll)
    match /pendingRolls/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Règles pour les récompenses de tournoi
    match /tournamentRewards/{userId} {
      // Lecture : L'utilisateur peut lire sa propre récompense
      allow read: if request.auth != null &&
                     (request.auth.uid == userId ||
                      request.auth.token.email == 'antho.pruneta@gmail.com');
      // Écriture : Admin uniquement
      allow write: if request.auth != null &&
                      request.auth.token.email == 'antho.pruneta@gmail.com';
    }
  }
}
